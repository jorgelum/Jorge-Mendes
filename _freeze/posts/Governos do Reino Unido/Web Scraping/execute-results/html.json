{
  "hash": "332b0086fe2963fb59aee73d498935a5",
  "result": {
    "markdown": "---\ntitle: \"Extraindo dados da wikipedia\"\nauthor: \"Jorge Luiz Mendes\"\neditor: visual\ndescription: \"Web Scraping da página da Wikipédia\"\ncategories: [web scraping, parlamento, governo, Reino Unido]\nimage: \"Parlamento.png\"\ndate: \"2022-11-03\"\ndraft: false\ntoc: true\n---\n\n\n## Introdução\n\nVenho me interessando pelo tema de raspagem de dados (Web Scraping) e resolvi trazer exemplo \"simples\" de como faze-lo. A ideia aqui é extrair os dados da página da Wikipédia, realizar o tratamento e fazer análise exploratória.\n\n## Tema\n\nRecentemente houve a troca do primeiro ministro do Reino Unido a premiê Liz Truss, sendo destacada por ser a que ficou menos tempo no cargo, foi substituída por Rishi Sunak. Esse [video](https://www.youtube.com/watch?v=t3vxUIbrTXE&t=20s) da BBC conta um pouco de quem foi Liz Truss e como foi seu governo.\n\n## Bibliotecas\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(forcats)\nlibrary(ggalt)\nlibrary(treemap)\nlibrary(magrittr) # pipe\nlibrary(lubridate)# tratamento de datas\nlibrary(knitr) # formatação de tabelas\nlibrary(rvest) # raspagem de dados\n```\n:::\n\n\n## Carregando os dados\n\nPara carregar os dados é necessário o [Link](https://pt.wikipedia.org/wiki/Lista_de_primeiros-ministros_do_Reino_Unido) da página da wikipédia e a tag da tabela. Para fazer isso basta clicar com o botão direito próxima a tabela desejada e escolher a opção inspecionar elemento, em seguida identificar tag da tabela e copiar seu XPath como mostra a figura 1.\n\n![Fígura 1](tag.png)\n\nCom essas informações podemos fazer a extração.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://pt.wikipedia.org/wiki/Lista_de_primeiros-ministros_do_Reino_Unido\"\ntag <- '//*[@id=\"mw-content-text\"]/div[1]/table[3]'\n\ndados <- url %>%  \n  rvest::read_html() %>% \n  rvest::html_node(xpath = tag) %>%\n  rvest::html_table()\n```\n:::\n\n\nPodemos verificar o tipo de estrutura.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"tbl_df\"     \"tbl\"        \"data.frame\"\n```\n:::\n:::\n\n\nPodemos inspessionar os nomes das colunas e os tipos de dados que estão presentes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"N.º\"                                                \n [2] \"Primeiro-ministro (Nascimento–Falecimento)\"         \n [3] \"Primeiro-ministro (Nascimento–Falecimento)\"         \n [4] \"Mandato (Duração em anos e dias)\"                   \n [5] \"Mandato (Duração em anos e dias)\"                   \n [6] \"Partido\"                                            \n [7] \"Partido\"                                            \n [8] \"Cargos ministeriais ocupados como primeiro-ministro\"\n [9] \"Monarca (Reino)\"                                    \n[10] \"Ref.\"                                               \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 188\nColumns: 10\n$ N.º                                                   <chr> \"1\", \"1\", \"1\", \"~\n$ `Primeiro-ministro (Nascimento–Falecimento)`          <chr> \"\", \"\", \"\", \"\", ~\n$ `Primeiro-ministro (Nascimento–Falecimento)`          <chr> \"Sir Robert Walp~\n$ `Mandato (Duração em anos e dias)`                    <chr> \"3 de abril de 1~\n$ `Mandato (Duração em anos e dias)`                    <chr> \"1722\", \"1727\", ~\n$ Partido                                               <chr> \"\", \"\", \"\", \"\", ~\n$ Partido                                               <chr> \"Whig\", \"Whig\", ~\n$ `Cargos ministeriais ocupados como primeiro-ministro` <chr> \"Chanceler do Te~\n$ `Monarca (Reino)`                                     <chr> \"Jorge I  (1714–~\n$ Ref.                                                  <chr> \"[20]\", \"[20]\", ~\n```\n:::\n:::\n\n\nAqui termina a parte simples.\n\n## Tratamento\n\nNem sempre os dados estão estrurados do jeito que gostariámos (aliás quase nunca está). O Dataframe obtido está bagunçado então precisamos realizar uma \"faxina\", padronizando as linhas e colunas.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# |message: false\n# |warnings: false\ndados %>% head(3) %>% knitr::kable(caption = \"A Tabela Original\")\n```\n\n::: {.cell-output-display}\nTable: A Tabela Original\n\n|N.º |Primeiro-ministro (Nascimento–Falecimento) |Primeiro-ministro (Nascimento–Falecimento)         |Mandato (Duração em anos e dias)             |Mandato (Duração em anos e dias) |Partido |Partido |Cargos ministeriais ocupados como primeiro-ministro                     |Monarca (Reino)       |Ref. |\n|:---|:------------------------------------------|:--------------------------------------------------|:--------------------------------------------|:--------------------------------|:-------|:-------|:-----------------------------------------------------------------------|:---------------------|:----|\n|1   |                                           |Sir Robert Walpole 1.º Conde de Orford (1676–1745) |3 de abril de 1721 – 11 de fevereiro de 1742 |1722                             |        |Whig    |Chanceler do TesouroPrimeiro Lorde do TesouroLíder da Câmara dos Comuns |Jorge I  (1714–1727)  |[20] |\n|1   |                                           |Sir Robert Walpole 1.º Conde de Orford (1676–1745) |3 de abril de 1721 – 11 de fevereiro de 1742 |1727                             |        |Whig    |Chanceler do TesouroPrimeiro Lorde do TesouroLíder da Câmara dos Comuns |Jorge II  (1727–1760) |[20] |\n|1   |                                           |Sir Robert Walpole 1.º Conde de Orford (1676–1745) |3 de abril de 1721 – 11 de fevereiro de 1742 |1734                             |        |Whig    |Chanceler do TesouroPrimeiro Lorde do TesouroLíder da Câmara dos Comuns |Jorge II  (1727–1760) |[20] |\n:::\n:::\n\n\nNão existe uma regra para realizar essa operação, a única certeza é que vai ser mais trabalhoso do que você pensou.\n\nO que me ajudou bastante foi desenhar e/ou imaginar a tabela final e fazer o simples mesmo que pareça preguiçoso, o importante é estar correto. Neste processo tem que ter paciência, pois uma operação equivocada (ou incompleta) pode ajudar a resolver um problema de um conjunto de linhas e simultaneamente prejudicar outro conjunto.\n\n::: {.callout-note collapse=\"true\"}\n## Atenção ao volume de dados!\n\nSempre é importante verificar a tabela após cada operação, mas uma coisa é inspessionar um Dataframe de 100 linhas, é mais facíl monitorar os erros, outra é inspessionar um Dataframe de 50000 linhas. Então tenha cuidado e bom senso.\n:::\n\nO processo é literalmente um aprendizado, ao longo do caminho você já sabe o que precisa ser descartado (seja linhas ou colunas), as micro alterações (ajustes específicos), as macro alterações (as mais perigosas) e que operações cada coluna necessita. Esse processo te aproxima do resultado que você espera.\n\n## Mão na massa\n\nExistem colunas com nomes idênticos mas informações diferentes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n df <-dados %>% select(c(1,3,4,7,8)) %>% #selecionei as colunas de interesse \n rename(\n   c('ministro'='Primeiro-ministro (Nascimento–Falecimento)','mandato'='Mandato (Duração em anos e dias)',\n     'cargo' ='Cargos ministeriais ocupados como primeiro-ministro'))  %>%  #renomeando as colunas \n   filter(!grepl('dias',mandato)) %>% # eliminei as linhas que estão poluindo \n   distinct() %>% # eliminei as linhas iguais\n   slice(-80) #eliminei a última linha manualmente\n```\n:::\n\n\nAgora quero colocar as datas em um formato em que o **R** interprete.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#separando as colunas\ndf %<>% separate(mandato,\n                c(\"InicioMandato\",\"FimMandato\"),\n                sep =\"–\",\n                convert = T,\n                remove = T,\n                )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# | message: false\n# Separando as colunas para obter dia,mês e ano do início e fim de mandato\ndf %<>% separate(InicioMandato,\n                c(\"DiaIM\",\"MesIM\",\"AnoIM\"),\n                sep =\"de \",\n                remove = T)\ndf %<>% separate(FimMandato,\n                c(\"DiaFM\",\"MesFM\",\"AnoFM\"),\n                sep =\"de \",\n                remove = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Expected 3 pieces. Missing pieces filled with `NA` in 1 rows [79].\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# obtendo um valor numérico dos meses\ndf %<>% mutate(MesIM = case_when(\n  MesIM == \"janeiro \" ~ 1,\n  MesIM == \"fevereiro \" ~ 2,\n  MesIM == \"março \" ~ 3,\n  MesIM == \"abril \" ~ 4,\n  MesIM == \"maio \" ~ 5,\n  MesIM == \"junho \" ~ 6,\n  MesIM == \"julho \" ~ 7,\n  MesIM == \"agosto \" ~ 8,\n  MesIM == \"setembro \" ~ 9,\n  MesIM == \"outubro \" ~ 10,\n  MesIM == \"novembro \" ~ 11,\n  MesIM == \"dezembro \" ~ 12\n),\n  MesFM = case_when(\n  MesFM == \"janeiro \" ~ 1,\n  MesFM == \"fevereiro \" ~ 2,\n  MesFM == \"março \" ~ 3,\n  MesFM == \"abril \" ~ 4,\n  MesFM == \"maio \" ~ 5,\n  MesFM == \"junho \" ~ 6,\n  MesFM == \"julho \" ~ 7,\n  MesFM == \"agosto \" ~ 8,\n  MesFM == \"setembro \" ~ 9,\n  MesFM == \"outubro \" ~ 10,\n  MesFM == \"novembro \" ~ 11,\n  MesFM == \"dezembro \" ~ 12))\n```\n:::\n\n\nÉ necessário uniformizar os dados, pois o espacinho em branco atrapalha as operações\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$AnoIM <- df$AnoIM %>% str_replace_all(\" \",\"\")\ndf$AnoFM <- df$AnoFM %>% str_replace_all(\" \",\"\")\n```\n:::\n\n\nAgora podemos unir as colunas criadas para formar a data completa.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# União das colunas \ndf %<>% unite(\"Data_Inicio_Mandato\",\n             c(\"AnoIM\",\"MesIM\",\"DiaIM\"),\n             sep = \"/\") \ndf %<>% unite(\"Data_Fim_Mandato\",\n             c(\"AnoFM\",\"MesFM\",\"DiaFM\"),\n             sep = \"/\") \n# convertendo para o formato de datas\ndf$Data_Inicio_Mandato %<>%  as.Date() # convertendo\ndf$Data_Fim_Mandato %<>%  as.Date()\n\ndf$Data_Fim_Mandato[is.na(df$Data_Fim_Mandato)] <- now() # como o ministro ainda está em exercício colocamos o dia atual como último dia. \n```\n:::\n\n\nCom o novo formato podemos obter a duração dos mandatos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %<>% mutate(duracao = df$Data_Fim_Mandato - df$Data_Inicio_Mandato)\n```\n:::\n\n\nAqui estão as alterações simples e preguiçosas. São modificações tão específicas que é mais viável fazer a alteração manual do que buscar um método mais elaborado.\n\n------------------------------------------------------------------------\n\n*Neste caso eram erros de ortografia e referências.*\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$ministro[df$ministro == \"Sir Robert Walpole 1.º Conde de Orford (1676–1745)\"] <- \"Sir Robert Walpole 1.º Conde de Oxford (1676–1745)\"\n\ndf$ministro[df$ministro == \t\"William Pitt, o Velho 1.º Conde de Chatham[a](1708–1778)\"] <-\"William Pitt, o Velho 1.º Conde de Chatham (1708–1778)\"\n\ndf$ministro[df$ministro == \t\"(1) William Pitt, o Novo[b](1759–1806)\"] <-\"(1) William Pitt, o Novo (1759–1806)\"\n\ndf$ministro[df$ministro == \t\"(2) Benjamin Disraeli 1.º Conde de Beaconsfield[c](1804–1881)\"] <-\"(2) Benjamin Disraeli 1.º Conde de Beaconsfield (1804–1881)\"\n\ndf$ministro[df$ministro == \t\"Alec Douglas-Home Barão Home de Hirsel[d](1894–1986)\"] <-\"Alec Douglas-Home Barão Home de Hirsel (1894–1986)\"\n```\n:::\n\n\nAgora com a tabela uniformizada podemos extrair um conjunto de caracteres utilizando expressões regulares (Regex). Neste caso queremos identificar e remover o padrão \"(Ano de Nascimento - Ano de Falecimento)\"\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$ministro <- df$ministro %>% str_replace_all(\"[(][0-9]{4}[–][0-9]{4}[)]|[(][0-9]{4}[)]\",\"\")\n```\n:::\n\n\nFinalmente temos a tabela tratada.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% head() %>% knitr::kable(caption = \"Tabela Tratada\")\n```\n\n::: {.cell-output-display}\nTable: Tabela Tratada\n\n|N.º |ministro                                        |Data_Inicio_Mandato |Data_Fim_Mandato |Partido |cargo                                                                               |duracao   |\n|:---|:-----------------------------------------------|:-------------------|:----------------|:-------|:-----------------------------------------------------------------------------------|:---------|\n|1   |Sir Robert Walpole 1.º Conde de Oxford          |1721-04-03          |1742-02-11       |Whig    |Chanceler do TesouroPrimeiro Lorde do TesouroLíder da Câmara dos Comuns             |7619 days |\n|2   |Spencer Compton 1.º Conde de Wilmington         |1742-02-16          |1743-07-02       |Whig    |Primeiro Lorde do Tesouro                                                           |501 days  |\n|3   |Henry Pelham                                    |1743-08-27          |1754-03-06       |Whig    |Chanceler do TesouroPrimeiro Lorde do TesouroLíder da Câmara dos Comuns             |3844 days |\n|4   |(1) Thomas Pelham-Holles 1.º Duque de Newcastle |1754-03-16          |1756-11-11       |Whig    |Primeiro Lorde do TesouroLíder da Câmara dos Comuns                                 |971 days  |\n|5   |William Cavendish 4.º Duque de Devonshire       |1756-11-16          |1757-06-29       |Whig    |Primeiro Lorde do TesouroLíder da Câmara dos ComunsLorde Alto Tesoureiro da Irlanda |225 days  |\n|6   |(2) Thomas Pelham-Holles 1.º Duque de Newcastle |1757-06-29          |1762-05-26       |Whig    |Primeiro Lorde do TesouroLíder da Câmara dos Comuns                                 |1792 days |\n:::\n:::\n\n\n## Visualizações\n\nQuem passou mais tempo no cargo?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# |message: false\n# |warnings: false\n\ntexto <- paste(\n  strwrap(\"Os 5 Primeiros-Ministros que permaneceram por mais tempo no cargo\",\n          30),\n  collapse = \"\\n\")\n\n\ndf %>% arrange(desc(duracao)) %>% \n  slice(1:5) %>% \n  ggplot(\n    aes(x = duracao,\n        y =ministro,\n        label = duracao)) +\n  geom_col(fill =\"#3c43c7\", size=0.05) + \n  geom_text(position = position_stack(vjust =1.05),\n            color=\"#030202\") +\n  \n  labs(title = texto,\n       subtitle = \"Duração em dias.\",\n       caption = \"(n) = contagem do mandato\",\n       y = \"\",\n       x =\"\" ) +\n    theme(axis.text.x = element_blank(),\n          axis.ticks.x=element_blank(),\n          axis.text.y =element_text(face =\"bold\",\n                                    colour = \"#030202\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nDon't know how to automatically pick scale for object of type difftime. Defaulting to continuous.\nDon't know how to automatically pick scale for object of type difftime. Defaulting to continuous.\nDon't know how to automatically pick scale for object of type difftime. Defaulting to continuous.\n```\n:::\n\n::: {.cell-output-display}\n![](Web-Scraping_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\nEm que mês costuma terminar os mandatos?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% group_by(mes = month(Data_Fim_Mandato, label = TRUE)) %>%   summarise(contagem =n()) %>% \n  ggplot(aes(x =mes,y =contagem, label = contagem ))+\n  geom_col(fill =\"#e05c09\") +\n  geom_text(vjust = 1.25) +\n  labs(title = \"Quantidade de términos de mandatos em cada mês\",\n       subtitle = \"Desde 1742.\", y =\"\",x=\"\") +\n  theme(axis.text.y = element_blank(),\n        axis.ticks.y= element_blank(),\n        axis.text.x = element_text(face =\"bold\",size =8,\n                                    colour = \"#030202\"),\n        plot.title = element_text(face =\"bold\", size = 14),\n        plot.subtitle = element_text(face = \"italic\", size = 10,\n                        margin = margin(b = 0.5, unit = \"cm\")))\n```\n\n::: {.cell-output-display}\n![](Web-Scraping_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n\nÚltimos ministros que passarem pelo cargo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf%>% filter(Data_Inicio_Mandato > \"2000-01-01\") %>% \n  mutate(\n    mandato_or = fct_reorder(ministro,Data_Inicio_Mandato))%>% \n  ggplot((aes(x=Data_Inicio_Mandato,xend = Data_Fim_Mandato,y = mandato_or))) +\n  geom_dumbbell(size =2.5,color=\"#cbcbd6\",colour_x =\"#3eb2f0\",\n                colour_xend = \"#0909ab\",dot_guide=TRUE,\n                dot_guide_size=0.25) +\n  labs(x =\"Ano\",y = \"\",title = \"Últimos Ministros\",\n       subtitle = \"A partir dos anos 2000\") +\n  theme(plot.title = element_text(face =\"bold\", size = 14),\n        plot.subtitle = element_text(face = \"italic\", size = 10,\n                        margin = margin(b = 0.5, unit = \"cm\")),\n        axis.text.y = element_text(face =\"bold\",size =10,\n                                    colour = \"#030202\"))\n```\n\n::: {.cell-output-display}\n![](Web-Scraping_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n\nQual partido mais governou?\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf  %>% group_by(Partido) %>% \n  summarise(Tempo = as.numeric(sum(duracao))) %>% \n  treemap(index = c(\"Tempo\",\"Partido\"),vSize = \"Tempo\",\n          align.labels=\n            list(c(\"center\", \"center\"),c(\"center\", \"top\")),\n          title = \"Tempo, em Dias, que Cada Partido Governou\",\n          fontsize.labels=c(12,10),\n          palette = \"BrBG\") \n```\n\n::: {.cell-output-display}\n![](Web-Scraping_files/figure-html/unnamed-chunk-40-1.png){width=672}\n:::\n:::\n\n\n::: {.callout-note collapse=\"true\"}\n## Curiosidade!\n\nAlguns partidos foram dissolvidos ou fundidos a outros partidos como por exemplo:\n\n-   Tory ⟹ Partido Conservador\n\n-   Wing ⟹ Partido Liberal\n:::\n\n## Sugestão\n\nUma boa ideia é extrair os títulos reais da coluna de ministros para realizar análises. Uma coluna que acabou não sendo utilizada é a de cargo, os cargos são strings que estão \"coladas\" uma na outra o desafio é separa-las\n\n## Ver também\n\n-   [Beatriz Milz](https://beamilz.com/posts/2021-05-24-naruto/pt/index.html)\n\n-   [Curso R](blog.curso-r.com/)\n",
    "supporting": [
      "Web-Scraping_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}